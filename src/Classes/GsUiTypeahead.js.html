<script id="krm-ui-run-form">
/**
 * @file GsUiTypeahead.js
 */
class GsUiTypeahead extends GsUi {
  /**
   * @class
   * @public
   * @param {object} config                   - Module configuration.
   * @param {string} config.formId            - ID selector used to target the parent form
   * @param {string} config.radiosContainerId - ID selector used to target the radios container
   * @param {Array}  config.spreadsheets      - Array of objects
   * @param {string} config.typeaheadId       - ID selector used to target the parent form
   */
  constructor(config = {}) {
    super();

    // accepts an object of named arguments
    this.formId = config.formId;
    this.radiosContainerId = config.radiosContainerId;
    this.spreadsheets = config.spreadsheets;
    this.typeaheadId = config.typeaheadId;

    // subscribe to other module's events
    pubsub.subscribe('domready', () => {
      this.init();
    });
  }

  /* Getters and Setters */

  /**
   * formId
   *
   * @type {string}
   */
  get formId() {
    return this._formId;
  }

  set formId(formId) {
    if (formId.trim().length > 0) {
      this._formId = formId;
    } else {
      throw new Error('GsUiTypeahead.formId cannot be empty');
    }
  }

  /**
   * radiosId
   *
   * @type {string}
   */
  get radiosContainerId() {
    return this._radiosContainerId;
  }

  set radiosContainerId(radiosContainerId) {
    if (radiosContainerId.trim().length > 0) {
      this._radiosContainerId = radiosContainerId;
    } else {
      throw new Error('GsUiTypeahead.radiosContainerId cannot be empty');
    }
  }

  /**
   * spreadsheets
   *
   * @type {Array}
   */
  get spreadsheets() {
    return this._spreadsheets;
  }

  set spreadsheets(spreadsheets) {
    if (Array.isArray(spreadsheets)) {
      this._spreadsheets = spreadsheets;
    } else {
      throw new Error('GsUiTypeahead.spreadsheets must be an Array');
    }
  }

  /**
   * typeaheadId
   *
   * @type {string}
   */
  get typeaheadId() {
    return this._typeaheadId;
  }

  set typeaheadId(typeaheadId) {
    if (typeaheadId.trim().length > 0) {
      this._typeaheadId = typeaheadId;
    } else {
      throw new Error('GsUiTypeahead.typeaheadId cannot be empty');
    }
  }

  /**
   * typeaheadInstance
   *
   * @type {object}
   */
  get typeaheadInstance() {
    return this._typeaheadInstance;
  }

  set typeaheadInstance(typeaheadInstance) {
    if (Object.prototype.toString.call(typeaheadInstance) === '[object Object]') {
      this._typeaheadInstance = typeaheadInstance;
    } else {
      throw new Error('GsUiTypeahead.typeaheadInstance requires an object');
    }
  }

  /* Instance methods */

  /**
   * handleChange
   *
   * @memberof GsUiTypeahead
   * @param {object} event - Event object
   */
  handleChange(event) {
    const changedEl = event.target;

    if (changedEl.name === 'dataSource') {
      const {
        sheetName,
        spreadsheetId,
      } = changedEl.dataset;

      google.script.run
        .withSuccessHandler(this.initTypeahead)
        .withFailureHandler(this.handleError)
        .gsSheetToJSON({
          id: spreadsheetId,
          sheet: sheetName,
        });
    }
  }

  /**
   * handleLoadError
   *
   * @memberof GsUiTypeahead
   * @param {string} error Error
   */
  handleLoadError(error) { // eslint-disable-line class-methods-use-this
    throw new Error(error);
  }

  /**
   * init
   *
   * @memberof GsUiTypeahead
   * @summary Runs on page load
   */
  init() {
    const {
      formId,
      radiosContainerId,
      spreadsheets,
      typeaheadId,
    } = this;

    const formEl = document.getElementById(formId);
    const radiosContainerEl = document.getElementById(radiosContainerId);
    const typeaheadEl = document.getElementById(typeaheadId);
    let html = '';

    if (typeaheadEl === null) {
      return;
    }

    // TODO generate radio buttons to switch source
    // on radio change, change source by destroying then running this load function

    spreadsheets.forEach((spreadsheet, i) => {
      const {
        id: spreadsheetId,
        sheet: sheetName,
      } = spreadsheet;

      html += '<div class="radio">';
      html += `<input type="radio" name="dataSource" id="spreadsheet-${i}" value="spreadsheet-${i}" data-sheet-name="${sheetName}" data-spreadsheet-id="${spreadsheetId}">`;
      html += `<label for="spreadsheet-${i}">${sheetName}</label>`;
      html += '</div>';
    });

    radiosContainerEl.innerHTML = html;

    formEl.addEventListener('change', this.handleChange.bind(this));

    setTimeout(() => {
      const radio1El = document.getElementById('spreadsheet-0');
      radio1El.click();
    }, 500);
  }

  /**
   * initTypeahead
   *
   * @memberof GsUiTypeahead
   * @summary Set up the search box
   * @param {Array} data Data
   */
  initTypeahead(data) { // eslint-disable-line class-methods-use-this
    // this is undefined in GAS callback
    const _this = gsUiTypeaheadInstance;

    const {
      typeaheadId,
    } = _this;

    // input element to attach to
    const typeaheadEl = document.getElementById(typeaheadId);

    if (typeof _this.typeaheadInstance !== 'undefined') {
      _this.typeaheadInstance.destroy();
    }

    _this.typeaheadInstance = typeahead({
      input: typeaheadEl,
      source: {
        local: JSON.parse(JSON.stringify(data)),
        identifier: 'name',
        // identity: (suggestion) => `${suggestion.business}${suggestion.address}`,
        // groupIdentifier: 'business',
        dataTokens: [ 'abbr', 'business', 'no', 'street' ], // fields user can search on
        diacritics: true, // in case this includes macrons
      },
      hint: false,
      autoSelect: false,
      highlight: true,
      templates: {
        suggestion: (item) => {
          const abbr = item.abbr ? ` (${item.abbr})` : '';
          const names = item.name.split(', ');
          const namesHtml = `<span class="tag tag-person">${names.join('</span><span class="tag tag-person">')}</span>`;

          return `<div class="text text-business">${item.business}${abbr}</div>
          <div class="text">${item.no} ${item.street}</div>
          <div class="text">${namesHtml}</div>`;
        },
        // group: (name) => `<div class="custom-group">${name}</div>`,
        // header: () => 'PODs',
        // footer: () => '<a href="#">See more...</a>',
        notFound: () => 'No results',
      },
    });
  }
}
</script>