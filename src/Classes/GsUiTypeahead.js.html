<script id="krm-ui-run-form">
/**
 * @file GsUiTypeahead.js
 */
class GsUiTypeahead extends GsUi {
  /**
   * @class
   * @public
   * @param {object} config                      - Module configuration.
   * @param {string} config.placeholderLogoClass - Class selector which applies the background logo
   * @param {string} config.typeaheadId          - ID selector used to target the typeahead
   */
  /* eslint-disable class-methods-use-this */
  constructor(config = {}) {
    super();

    // accepts an object of named arguments
    const options = {
      placeholderLogoClass: 'bg-logo',
      typeaheadId: 'typeahead',
    };

    // private settings
    // Note: when using setAttribute, any non-string value specified is automatically converted into a string.

    // merge config and options objects to create this instance's settings
    this._settings = { ...options, ...config, ...super.settings };

    // subscribe to other module's events

    pubsub.subscribe('domready', (data) => {
      this.init();
    });
  }

  /* Instance methods */

  /**
   * handleLoadError
   *
   * @param {string} error Error
   */
  handleLoadError(error) {
    throw new Error(error);
  }

  /**
   * init
   *
   * @summary Runs on page load
   */
  init() {
    const {
      typeaheadId,
    } = this._settings;

    const typeaheadEl = document.getElementById(typeaheadId);

    if (typeaheadEl === null) {
      return;
    }

    google.script.run
      .withSuccessHandler(this.initTypeahead)
      .withFailureHandler(this.handleError)
      .gsSheetToJSON();
  }

  /**
   * initTypeahead
   *
   * @summary Set up the search box
   */
  initTypeahead(data) {
    const { typeaheadId } = gsUiTypeaheadInstance._settings; // 'this' is undefined

    // input element to attach to
    const inputElement = document.getElementById(typeaheadId);

    const instance = typeahead({ // eslint-disable-line no-unused-vars
      input: inputElement,
      source: {
        local: JSON.parse(JSON.stringify(data)),
        identifier: 'name',
        // identity: (suggestion) => `${suggestion.business}${suggestion.address}`,
        groupIdentifier: 'business',
        dataTokens: [ 'abbr', 'business', 'no', 'street' ], // fields one can search on
        diacritics: true,
      },
      hint: false,
      autoSelect: false,
      highlight: true,
      templates: {
        suggestion: (item) => {
          // const abbr = item.abbr ? ` (${item.abbr})` : '';
          // ${abbr}

          return `<div class="text">LOCATION: ${item.no} ${item.street}</div>
          <div class="text">PEOPLE: <span>${item.name}</span></div>`;
        },
        group: (name) => `<div class="custom-group">${name}</div>`,
        // header: () => 'PODs',
        // footer: () => '<a href="#">See more...</a>',
        notFound: () => 'No results',
      },
    });
  }

  /**
   * showPlaceholderLogo
   *
   * @memberof GsUiTypeahead
   * @summary Show the placeholder logo when the run form is not present.
   * @param {boolean} show Whether to show the placeholder
   */
  showPlaceholderLogo(show) {
    const { placeholderLogoClass } = this._settings;

    if (show) {
      document.body.classList.add(placeholderLogoClass);
    } else {
      document.body.classList.remove(placeholderLogoClass);
    }
  }
}
</script>